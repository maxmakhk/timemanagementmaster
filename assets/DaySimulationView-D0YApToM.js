import{_ as ie,u as oe,x as re,f as de,c as h,a as t,b as A,t as d,l as _,F as H,i as G,m as ce,r as D,k as p,e as ve,o as f,n as me}from"./index-BO_G86Ar.js";import{g as ye}from"./activities-D1PaX-zk.js";const he={class:"day-simulation-view"},pe={class:"header-content"},fe=["src"],ge={class:"header-info"},De={key:0},_e={key:1,class:"simulation-status"},Ce={key:2,class:"simulation-status"},$e={class:"progress-bar"},be={key:0,class:"simulation-container"},xe={class:"npc-tabs"},we=["onClick"],Ne={class:"status-bar"},Pe={class:"status-item energy-bar"},Se={class:"bar"},Re={class:"status-value"},Ie={class:"status-item mood-bar"},Me={class:"bar"},Ae={class:"status-value"},Ee={class:"combined-content"},ke={class:"log-section"},qe={class:"abilities-section"},Te={class:"abilities-grid"},je={class:"ability-card"},Qe={class:"ability-bar"},Be={class:"ability-value"},Je={class:"ability-card"},Oe={class:"ability-bar"},Ve={class:"ability-value"},Fe={class:"ability-card"},ze={class:"ability-bar"},Ke={class:"ability-value"},He={class:"ability-card"},Ge={class:"ability-bar"},Ue={class:"ability-value"},We={class:"ability-card"},Xe={class:"ability-bar"},Ye={class:"ability-value"},Ze={class:"action-buttons"},Le={key:1,class:"simulation-message"},E=100,ea={__name:"DaySimulationView",setup(aa){const k=ve(),{t:U}=oe(),a=D(null),$=D(0),B=D(0),g=D({}),P=D(null),b=D(""),x=D(null),M=D(!1),W=D(0),q=D(!1),J=p(()=>a.value?a.value.extendedDays&&a.value.extendedDays[i.value?.id]?a.value.extendedDays[i.value.id]:Math.max(...a.value.selectedNPCs.map(s=>s.requiredDays||5)):5),i=p(()=>a.value?a.value.selectedNPCs[B.value]:null),c=p(()=>!a.value||!P.value?i.value:a.value.selectedNPCs.find(s=>s.id===P.value)||i.value),r=p(()=>!a.value||!c.value?null:a.value.npcCurrentAbilities[c.value.id]||{}),X=p(()=>!a.value||!c.value?J.value:a.value.extendedDays?.[c.value.id]||c.value.requiredDays||J.value),Y=p(()=>{const s=c.value?.name||i.value?.name||"",e=$.value+1,l=X.value,n=b.value||"",u=n?`Day ${e} ${n}`:`Day ${e}`;return`${U("day.title")} - ${u} / ${l} å¤© (${s})`}),Z=p(()=>!x.value||!x.value.bgImage?"/images/time-management/bg_default.png":x.value.bgImage),O=p(()=>{if(!c.value)return null;const s=c.value.name;return!x.value||!x.value.activityKey?`/images/time-management/${s}_default.png`:`/images/time-management/${s}_${x.value.activityKey}.png`}),V=p(()=>c.value?g.value[c.value.id]||[]:[]),T=D(null),L=()=>{T.value&&setTimeout(()=>{T.value.scrollTop=T.value.scrollHeight},100)};re(()=>V.value.length,()=>{L()});const ee=p(()=>!a.value||!i.value?null:a.value.npcCurrentAbilities[i.value.id]||{});de(()=>{const s=sessionStorage.getItem("simulationData");s?(a.value=JSON.parse(s),a.value.npcCurrentDays||(a.value.npcCurrentDays={},a.value.selectedNPCs.forEach(e=>{a.value.npcCurrentDays[e.id]=0})),$.value=a.value.npcCurrentDays[a.value.selectedNPCs[0].id]||0,a.value.selectedNPCs&&a.value.selectedNPCs.forEach(e=>{g.value[e.id]||(g.value[e.id]=[])}),i.value&&(P.value=i.value.id),te()):(alert("ç„¡æ³•è¼‰å…¥æ¨¡æ“¬æ•¸æ“š"),k.push("/time-management/schedule"))});const w=s=>new Promise(e=>setTimeout(e,s)),ae=async(s,e,l,n)=>{l.push(`â° ${e.time} - ${e.activity}`);const u=ye(e.activity);x.value=u||null;let C={coding:0,math:0,fitness:0};if(u?.isRest)n.energy=100,n.mood=100,l.push("  âœ“ ç²¾åŠ›æ¢å¾©è‡³ 100"),l.push("  âœ“ å¿ƒæƒ…æ¢å¾©è‡³ 100");else if(e.activity==="Lunch")n.energy=Math.min(n.energy+50,100),l.push("  âœ“ ç²¾åŠ› +50");else{const N=u?.cost||{energy:30,mood:50},S=n.energy,R=n.mood;n.energy-=N.energy,n.mood-=N.mood,l.push(`  ğŸ“‰ ç²¾åŠ›æ¶ˆè€— ${N.energy} (${S} â†’ ${Math.max(n.energy,0)})`),l.push(`  ğŸ“‰ å¿ƒæƒ…æ¶ˆè€— ${N.mood} (${R} â†’ ${Math.max(n.mood,0)})`);let y=1;if((n.energy<0||n.mood<0)&&(y=.5,l.push("  âš ï¸ èƒ½é‡æˆ–å¿ƒæƒ…ä¸è¶³ï¼Œå­¸ç¿’æ•ˆæœé™ä½ 50%")),e.effect.coding){const v=Math.floor(e.effect.coding*y);C.coding=v,l.push(`  âœ“ ç·¨ç¨‹èƒ½åŠ› +${v}`)}if(e.effect.math){const v=Math.floor(e.effect.math*y);C.math=v,l.push(`  âœ“ æ•¸å­¸èƒ½åŠ› +${v}`)}if(e.effect.fitness){const v=Math.floor(e.effect.fitness*y);C.fitness=v,l.push(`  âœ“ èº«é«”ç´ è³ª +${v}`)}}return n.energy=Math.max(n.energy,0),n.mood=Math.max(n.mood,0),C},se=async(s,e)=>{P.value=s.id,W.value=e,b.value="æº–å‚™ä¸­";const l=a.value.npcCurrentDays?.[s.id]??0;g.value[s.id]||(g.value[s.id]=[]),g.value[s.id]=[];const n=a.value.npcCurrentAbilities[s.id];n.energy=100,n.mood=100;const u=g.value[s.id];u.push(`ğŸ“… ç¬¬ ${l+1} å¤© - ${s.name} çš„æ—¥ç¨‹`),u.push("---"),await w(500);const S=(a.value.npcSchedules[s.id]?.[l]||[]).map((o,m)=>o?{slotIndex:m,time:["08:00","10:00","12:00","14:00","16:00","18:00"][m],activity:o.name,effect:o.effect}:null).filter(o=>o!==null),R=s.requiredDays||5,v=a.value?.extendedDays?.[s.id]||R;if(l===v){u.push("ğŸ“ ä»Šå¤©æ˜¯è€ƒè©¦æ—¥ï¼"),u.push("---"),b.value="è€ƒè©¦ä¸­",await w(E);const o=z();o&&(u.push("ğŸ“ === è€ƒè©¦çµæœ === ğŸ“"),u.push("---"),u.push(`ğŸ“‹ è€ƒè©¦å˜—è©¦æ¬¡æ•¸: #${o.examAttempt}`),u.push("---"),u.push("ğŸ“Š æŠ€èƒ½è©•ä¼°ï¼š"),o.skillResults.forEach(m=>{const j=m.passed?"âœ… é€šé":"âŒ æœªé€šé",Q="â–ˆ".repeat(Math.floor(m.percentage/10))+"â–‘".repeat(10-Math.floor(m.percentage/10));u.push(`  ${m.emoji} ${m.name}: ${m.current}/${m.goal} (${m.percentage}%) ${j}`),u.push(`     ${Q}`)}),u.push("---"),u.push(`ğŸ“ˆ ç¸½é«”é€šéç‡: ${o.passedSkills}/3 æŠ€èƒ½`),o.passed?(u.push("ğŸ‰ === è€ƒè©¦é€šéï¼ === ğŸ‰"),u.push(`ğŸ† ç²å¾—è²æœ›: ${o.finalReward}`),u.push("âœ¨ æ­å–œå®Œæˆä»»å‹™ï¼")):(u.push("ğŸ˜” === è€ƒè©¦æœªé€šé === ğŸ˜”"),u.push(`âš ï¸ ${3-o.passedSkills} å€‹æŠ€èƒ½æœªé”æ¨™`),u.push("ğŸ’¡ å»ºè­°ï¼šéœ€è¦æ›´å¤šå­¸ç¿’æ™‚é–“"),o.examAttempt>1&&u.push(`ğŸ“‰ è²æœ›çå‹µå·²é™ä½: ${o.originalReward} â†’ ${o.finalReward} (-${Math.round((1-o.finalReward/o.originalReward)*100)}%)`)),u.push("---")),b.value="è€ƒè©¦å®Œæˆ",await w(E)}else if(S.length===0)u.push("âœ— ä»Šå¤©æ²’æœ‰å®‰æ’è¡Œç¨‹"),b.value="ç„¡è¡Œç¨‹",await w(E);else{let o=0,m=0,j=0;for(const Q of S){b.value=Q.time;const I=await ae(s,Q,u,n);o+=I.coding,m+=I.math,j+=I.fitness,n.coding+=I.coding,n.math+=I.math,n.fitness+=I.fitness,await w(E)}u.push("---"),u.push("ğŸ“Š ä»Šæ—¥ç¸½é€²åº¦ï¼š"),u.push(`  ç·¨ç¨‹ï¼š${n.coding-o} â†’ ${n.coding}`),u.push(`  æ•¸å­¸ï¼š${n.math-m} â†’ ${n.math}`),u.push(`  èº«é«”ï¼š${n.fitness-j} â†’ ${n.fitness}`),u.push(`  ç²¾åŠ›ï¼š${n.energy}`),u.push(`  å¿ƒæƒ…ï¼š${n.mood}`),await w(E),u.push("âœ… ä¸€å¤©çµæŸ"),b.value="å®Œæˆ"}a.value.npcCurrentDays[s.id]=l,await w(1500)},te=async()=>{if(!(!a.value||M.value)){M.value=!0,q.value=!1;for(let s=0;s<a.value.selectedNPCs.length;s++){const e=a.value.selectedNPCs[s];await se(e,s)}M.value=!1,q.value=!0}},F=p(()=>{if(!i.value)return!1;const s=i.value.requiredDays||5,l=a.value?.extendedDays?.[i.value.id]||s;return $.value===l}),z=()=>{if(!i.value)return console.error("currentNPC is null"),null;if(!i.value.goals)return console.error("currentNPC.goals is missing",i.value),null;const s=a.value.examAttempt||1,e=[{name:"Coding",emoji:"ğŸ“š",key:"coding",goal:i.value.goals.coding},{name:"Math",emoji:"ğŸ”¢",key:"math",goal:i.value.goals.math},{name:"Fitness",emoji:"ğŸ’ª",key:"fitness",goal:i.value.goals.fitness}];let l=0;const n=e.map(y=>{const v=ee.value[y.key]||0,K=Math.round(v/y.goal*100),o=v>=y.goal;return o&&l++,{name:y.name,emoji:y.emoji,key:y.key,current:v,goal:y.goal,percentage:Math.min(K,100),passed:o}}),u=l===3,C=i.value?.rewards?.masterReputation||10,N=Math.pow(.75,s-1),S=Math.round(C*N),R={skillResults:n,passedSkills:l,passed:u,originalReward:C,finalReward:S,requiredDays:i.value?.requiredDays||5,examAttempt:s,currentNPC:i.value,questIndex:B.value};return console.log("Exam results calculated:",R),R},le=()=>{const s=z();if(!s||!i.value){g.value[i.value?.id]||(g.value[i.value.id]=[]),g.value[i.value.id].push("âŒ ç„¡æ³•è¨ˆç®—è€ƒè©¦çµæœ");return}const e=g.value[i.value.id];return e.push("---"),e.push("ğŸ“ === è€ƒè©¦çµæœ === ğŸ“"),e.push("---"),e.push(`ğŸ“‹ è€ƒè©¦å˜—è©¦æ¬¡æ•¸: #${s.examAttempt}`),e.push("---"),e.push("ğŸ“Š æŠ€èƒ½è©•ä¼°ï¼š"),s.skillResults.forEach(l=>{const n=l.passed?"âœ… é€šé":"âŒ æœªé€šé",u="â–ˆ".repeat(Math.floor(l.percentage/10))+"â–‘".repeat(10-Math.floor(l.percentage/10));e.push(`  ${l.emoji} ${l.name}: ${l.current}/${l.goal} (${l.percentage}%) ${n}`),e.push(`     ${u}`)}),e.push("---"),e.push(`ğŸ“ˆ ç¸½é«”é€šéç‡: ${s.passedSkills}/3 æŠ€èƒ½`),s.passed?(e.push("ğŸ‰ === è€ƒè©¦é€šéï¼ === ğŸ‰"),e.push(`ğŸ† ç²å¾—è²æœ›: ${s.finalReward}`),e.push("âœ¨ æ­å–œå®Œæˆä»»å‹™ï¼"),a.value.completedQuests=a.value.completedQuests||[],a.value.completedQuests.push({id:i.value.id,reward:s.finalReward,passed:!0})):(e.push("ğŸ˜” === è€ƒè©¦æœªé€šé === ğŸ˜”"),e.push(`âš ï¸ ${3-s.passedSkills} å€‹æŠ€èƒ½æœªé”æ¨™`),e.push("ğŸ’¡ å»ºè­°ï¼šéœ€è¦æ›´å¤šå­¸ç¿’æ™‚é–“"),s.examAttempt>1&&e.push(`ğŸ“‰ è²æœ›çå‹µå·²é™ä½: ${s.originalReward} â†’ ${s.finalReward} (-${Math.round((1-s.finalReward/s.originalReward)*100)}%)`)),e.push("---"),s},ne=()=>{if(console.log("completeDay called, currentDay:",$.value,"isExamDay:",F.value),F.value){const s=le();if(s&&s.passed){a.value.npcCurrentDays||(a.value.npcCurrentDays={}),a.value.npcPassStatus||(a.value.npcPassStatus={}),a.value.npcCurrentDays[i.value.id]=-1,a.value.npcPassStatus[i.value.id]=!0;const e={selectedNPCs:a.value.selectedNPCs,npcSchedules:a.value.npcSchedules,npcCurrentAbilities:a.value.npcCurrentAbilities,npcCurrentDays:a.value.npcCurrentDays,npcPassStatus:a.value.npcPassStatus,completedQuestIds:a.value.completedQuestIds||[],extendedDays:a.value.extendedDays};e.completedQuestIds.includes(i.value.id)||e.completedQuestIds.push(i.value.id),sessionStorage.setItem("scheduleState",JSON.stringify(e)),sessionStorage.setItem("simulationData",JSON.stringify(a.value)),k.push("/time-management/schedule")}else if(s){const e=i.value.requiredDays,l=i.value.id;a.value.npcCurrentDays||(a.value.npcCurrentDays={}),a.value.npcCurrentDays[l]=e+1,a.value.examAttempt=(a.value.examAttempt||1)+1,a.value.extendedDays=a.value.extendedDays||{},a.value.extendedDays[l]=e+1+5,sessionStorage.setItem("simulationData",JSON.stringify(a.value)),k.push("/time-management/schedule")}}else a.value.npcCurrentDays||(a.value.npcCurrentDays={}),a.value.selectedNPCs.forEach(s=>{a.value.npcCurrentDays[s.id]!==-1&&(a.value.npcCurrentDays[s.id]=(a.value.npcCurrentDays[s.id]||0)+1)}),$.value++,a.value.currentDay=$.value,sessionStorage.setItem("simulationData",JSON.stringify(a.value)),k.push("/time-management/schedule")},ue=p(()=>{const s=a.value?.selectedNPCs.length||1,e=J.value*s;return($.value*s+B.value+1)/e*100});return(s,e)=>(f(),h("div",he,[t("header",{class:"simulation-header",style:_({backgroundImage:`url(${Z.value})`})},[e[2]||(e[2]=t("div",{class:"header-overlay"},null,-1)),t("div",pe,[O.value?(f(),h("img",{key:0,src:O.value,class:"header-character",alt:"Character"},null,8,fe)):A("",!0),t("div",ge,[c.value||i.value?(f(),h("h1",De,d(Y.value),1)):A("",!0),M.value?(f(),h("div",_e,[...e[0]||(e[0]=[t("span",{class:"status-indicator running"},"â³",-1),t("span",null,"æ­£åœ¨é‹è¡Œä¸­...",-1)])])):q.value?(f(),h("div",Ce,[...e[1]||(e[1]=[t("span",{class:"status-indicator complete"},"âœ…",-1),t("span",null,"æ¨¡æ“¬å®Œæˆ",-1)])])):A("",!0),t("div",$e,[t("div",{class:"progress",style:_({width:ue.value+"%"})},null,4)])])])],4),a.value?(f(),h("div",be,[t("div",xe,[(f(!0),h(H,null,G(a.value.selectedNPCs,l=>(f(),h("button",{key:l.id,class:me(["npc-tab",{active:P.value===l.id}]),onClick:n=>P.value=l.id},d(l.image)+" "+d(l.name),11,we))),128))]),t("div",Ne,[t("div",Pe,[e[3]||(e[3]=t("span",{class:"status-label"},"âš¡ ç²¾åŠ›",-1)),t("div",Se,[t("div",{class:"fill",style:_({width:r.value?.energy||"0%",backgroundColor:r.value?.energy>50?"#2ecc71":r.value?.energy>25?"#f39c12":"#e74c3c"})},null,4)]),t("span",Re,d(r.value?.energy||0)+"/100",1)]),t("div",Ie,[e[4]||(e[4]=t("span",{class:"status-label"},"ğŸ˜Š å¿ƒæƒ…",-1)),t("div",Me,[t("div",{class:"fill",style:_({width:r.value?.mood||"0%",backgroundColor:r.value?.mood>50?"#3498db":r.value?.mood>25?"#f39c12":"#e74c3c"})},null,4)]),t("span",Ae,d(r.value?.mood||0)+"/100",1)])]),t("div",Ee,[t("div",ke,[t("h2",null,"ğŸ“ "+d(s.$t("day.eventLog")),1),t("div",{ref_key:"logContainer",ref:T,class:"log-container"},[(f(!0),h(H,null,G(V.value,(l,n)=>(f(),h("div",{key:n,class:"log-entry"},d(l),1))),128))],512)]),t("div",qe,[t("h2",null,"ğŸ“Š "+d(c.value?.name)+" ç•¶å‰èƒ½åŠ›å€¼",1),t("div",Te,[t("div",je,[e[5]||(e[5]=t("div",{class:"ability-name"},"ğŸ“š ç·¨ç¨‹",-1)),t("div",Qe,[t("div",{class:"ability-fill",style:_({width:r.value?.coding/100*100+"%"})},null,4)]),t("div",Be,d(r.value?.coding||0)+" / "+d(c.value?.goals?.coding||0),1)]),t("div",Je,[e[6]||(e[6]=t("div",{class:"ability-name"},"ğŸ”¢ æ•¸å­¸",-1)),t("div",Oe,[t("div",{class:"ability-fill",style:_({width:r.value?.math/100*100+"%"})},null,4)]),t("div",Ve,d(r.value?.math||0)+" / "+d(c.value?.goals?.math||0),1)]),t("div",Fe,[e[7]||(e[7]=t("div",{class:"ability-name"},"ğŸ’ª èº«é«”",-1)),t("div",ze,[t("div",{class:"ability-fill",style:_({width:r.value?.fitness/100*100+"%"})},null,4)]),t("div",Ke,d(r.value?.fitness||0)+" / "+d(c.value?.goals?.fitness||0),1)]),t("div",He,[e[8]||(e[8]=t("div",{class:"ability-name"},"ğŸ˜Š å¿ƒæƒ…",-1)),t("div",Ge,[t("div",{class:"ability-fill",style:_({width:(r.value?.mood||0)+"%"})},null,4)]),t("div",Ue,d(r.value?.mood||0)+"/100",1)]),t("div",We,[e[9]||(e[9]=t("div",{class:"ability-name"},"âš¡ ç²¾åŠ›",-1)),t("div",Xe,[t("div",{class:"ability-fill",style:_({width:(r.value?.energy||0)+"%"})},null,4)]),t("div",Ye,d(r.value?.energy||0)+"/100",1)])])])])])):A("",!0),t("div",Ze,[q.value?(f(),h("button",{key:0,onClick:ne,class:"btn btn-primary"},d(s.$t("day.completeDay")),1)):M.value?(f(),h("div",Le,[...e[10]||(e[10]=[t("span",{class:"spinner"},null,-1),ce(" æ­£åœ¨æ¨¡æ“¬æ¯ä½å­¸ç”Ÿçš„ä¸€å¤©... ",-1)])])):A("",!0)])]))}},la=ie(ea,[["__scopeId","data-v-0f1d0ac8"]]);export{la as default};
